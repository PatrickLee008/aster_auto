{% extends "base.html" %}

{% block page_title %}é’±åŒ…ç®¡ç†{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWalletModal">
    <i class="fas fa-plus"></i> æ·»åŠ é’±åŒ…
</button>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet"></i> æˆ‘çš„é’±åŒ…</h5>
            </div>
            <div class="card-body">
                {% if wallets %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>é’±åŒ…åç§°</th>
                                <th>ç±»å‹</th>
                                <th>åœ°å€ä¿¡æ¯</th>
                                <th>ä½™é¢ä¿¡æ¯</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æœ€åä½¿ç”¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for wallet in wallets %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ wallet.name }}</strong>
                                        {% if wallet.description %}
                                        <br><small class="text-muted">{{ wallet.description }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if wallet.wallet_type == 'spot' %}
                                        <span class="badge bg-info">ç°è´§</span>
                                    {% elif wallet.wallet_type == 'futures' %}
                                        <span class="badge bg-warning">åˆçº¦</span>
                                    {% elif wallet.wallet_type == 'unified' %}
                                        <span class="badge bg-success">ç»Ÿä¸€</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if wallet.wallet_type == 'spot' %}
                                        <small class="text-muted">
                                            {% set masked = wallet.get_masked_credentials() %}
                                            API Key: {{ masked.api_key if masked.api_key else 'N/A' }}
                                        </small>
                                    {% elif wallet.wallet_type == 'futures' %}
                                        <small class="text-muted">
                                            ç”¨æˆ·åœ°å€: {{ wallet.user_address[:10] + '...' if wallet.user_address else 'N/A' }}<br>
                                            ç­¾ååœ°å€: {{ wallet.signer_address[:10] + '...' if wallet.signer_address else 'N/A' }}
                                        </small>
                                    {% elif wallet.wallet_type == 'unified' %}
                                        <small class="text-muted">
                                            {% set masked = wallet.get_masked_credentials() %}
                                            ç°è´§API: {{ masked.api_key[:10] + '...' if masked.api_key else 'N/A' }}<br>
                                            åˆçº¦åœ°å€: {{ wallet.user_address[:10] + '...' if wallet.user_address else 'N/A' }}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div id="balance-{{ wallet.id }}" class="text-muted">
                                        <small>
                                            <i class="fas fa-sync fa-spin" style="display: none;"></i>
                                            <span class="balance-content">ç‚¹å‡»æµ‹è¯•æŸ¥çœ‹ä½™é¢</span>
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    {% if wallet.is_active %}
                                        <span class="badge bg-success">æ´»è·ƒ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">ç¦ç”¨</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ wallet.created_at.strftime('%Y-%m-%d') }}</small>
                                </td>
                                <td>
                                    <small>
                                        {% if wallet.last_used %}
                                            {{ wallet.last_used.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            æœªä½¿ç”¨
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="testConnection({{ wallet.id }})">
                                            <i class="fas fa-plug"></i> æµ‹è¯•
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary"
                                                onclick="editWallet({{ wallet.id }})">
                                            <i class="fas fa-edit"></i> ç¼–è¾‘
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="deleteWallet({{ wallet.id }})">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">æš‚æ— é’±åŒ…é…ç½®</h5>
                    <p class="text-muted">æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªé’±åŒ…é…ç½®ä»¥å¼€å§‹äº¤æ˜“</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWalletModal">
                        <i class="fas fa-plus"></i> æ·»åŠ é’±åŒ…
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ é’±åŒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="addWalletModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> åˆ›å»ºç»Ÿä¸€é’±åŒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addWalletForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="walletName" class="form-label">é’±åŒ…åç§° *</label>
                                <input type="text" class="form-control" id="walletName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="isActive" class="form-label">çŠ¶æ€</label>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                                    <label class="form-check-label" for="isActive">
                                        å¯ç”¨é’±åŒ…
                                    </label>
                                </div>
                                <input type="hidden" id="walletType" name="wallet_type" value="unified">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="walletDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="walletDescription" name="description" rows="2" placeholder="å¯é€‰ï¼Œæè¿°è¿™ä¸ªé’±åŒ…çš„ç”¨é€”"></textarea>
                    </div>
                    
                    <!-- ç»Ÿä¸€é’±åŒ…è¯´æ˜ -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> ç»Ÿä¸€é’±åŒ…è¯´æ˜</h6>
                        <p class="mb-0">ç»Ÿä¸€é’±åŒ…éœ€è¦åŒæ—¶é…ç½®ç°è´§å’ŒæœŸè´§APIï¼Œå¯ä»¥ç”¨äºæ‰€æœ‰ç±»å‹çš„äº¤æ˜“ç­–ç•¥ã€‚è¯·ç¡®ä¿å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯ã€‚</p>
                    </div>
                    
                    <!-- ç°è´§é…ç½® -->
                    <div id="spotConfig">
                        <h6 class="text-primary"><i class="fas fa-coins"></i> ç°è´§APIé…ç½®</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="spotApiKey" class="form-label">ç°è´§API Key *</label>
                                    <input type="text" class="form-control" id="spotApiKey" name="spot_api_key" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="spotSecretKey" class="form-label">ç°è´§Secret Key *</label>
                                    <input type="password" class="form-control" id="spotSecretKey" name="spot_secret_key" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆçº¦é…ç½® -->
                    <div id="futuresConfig">
                        <h6 class="text-warning"><i class="fas fa-chart-line"></i> åˆçº¦APIé…ç½®</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userAddress" class="form-label">æœŸè´§ç”¨æˆ·åœ°å€ *</label>
                                    <input type="text" class="form-control" id="userAddress" name="user_address" placeholder="0x..." required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="signerAddress" class="form-label">æœŸè´§ç­¾ååœ°å€ *</label>
                                    <input type="text" class="form-control" id="signerAddress" name="signer_address" placeholder="0x..." required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="privateKey" class="form-label">æœŸè´§ç§é’¥ *</label>
                            <input type="password" class="form-control" id="privateKey" name="private_key" placeholder="0x..." required>
                        </div>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜é’±åŒ…
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘é’±åŒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="editWalletModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ç¼–è¾‘é’±åŒ…é…ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editWalletForm">
                <input type="hidden" id="editWalletId" name="wallet_id">
                <div class="modal-body">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="editWalletName" class="form-label">é’±åŒ…åç§° *</label>
                                <input type="text" class="form-control" id="editWalletName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                                <label class="form-check-label" for="editIsActive">
                                    <i class="fas fa-check-circle text-success"></i> å¯ç”¨é’±åŒ…
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="editWalletDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="editWalletDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <!-- ç°è´§APIé…ç½® -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-coins"></i> ç°è´§äº¤æ˜“APIé…ç½®</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editSpotApiKey" class="form-label">ç°è´§API Key</label>
                                        <input type="text" class="form-control" id="editSpotApiKey" name="spot_api_key" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                                        <small class="text-muted">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å½“å‰å¯†é’¥</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editSpotSecretKey" class="form-label">ç°è´§Secret Key</label>
                                        <input type="password" class="form-control" id="editSpotSecretKey" name="spot_secret_key" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                                        <small class="text-muted">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å½“å‰å¯†é’¥</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆ†éš”çº¿ -->
                    <hr class="my-4" style="border-top: 2px solid #dee2e6;">
                    
                    <!-- åˆçº¦APIé…ç½® -->
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-chart-line"></i> åˆçº¦äº¤æ˜“APIé…ç½®</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editUserAddress" class="form-label">ç”¨æˆ·åœ°å€</label>
                                        <input type="text" class="form-control" id="editUserAddress" name="user_address" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                                        <small class="text-muted">ä»¥å¤ªåŠé’±åŒ…åœ°å€ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editSignerAddress" class="form-label">ç­¾ååœ°å€</label>
                                        <input type="text" class="form-control" id="editSignerAddress" name="signer_address" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                                        <small class="text-muted">ç”¨äºäº¤æ˜“ç­¾åçš„åœ°å€ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editPrivateKey" class="form-label">ç§é’¥</label>
                                <input type="password" class="form-control" id="editPrivateKey" name="private_key" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                                <small class="text-muted">ç”¨äºç­¾åäº¤æ˜“çš„ç§é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼Œç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ç»Ÿä¸€é’±åŒ…é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰é…ç½®åŒºåŸŸ
    // ä¸å†éœ€è¦é’±åŒ…ç±»å‹åˆ‡æ¢é€»è¾‘
    
    
    // æäº¤é’±åŒ…è¡¨å•
    $('#addWalletForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        
        // åŸºæœ¬ä¿¡æ¯
        formData.append('name', $('#walletName').val());
        formData.append('description', $('#walletDescription').val());
        formData.append('is_active', $('#isActive').is(':checked'));
        formData.append('wallet_type', 'unified');
        
        // ç»Ÿä¸€é’±åŒ…é…ç½® - ç°è´§API
        const spotApiKey = $('#spotApiKey').val();
        const spotSecretKey = $('#spotSecretKey').val();
        
        formData.append('spot_api_key', spotApiKey);
        formData.append('spot_secret_key', spotSecretKey);
        
        // ç»Ÿä¸€é’±åŒ…é…ç½® - æœŸè´§API  
        const userAddress = $('#userAddress').val();
        const signerAddress = $('#signerAddress').val();
        const privateKey = $('#privateKey').val();
        
        formData.append('user_address', userAddress);
        formData.append('signer_address', signerAddress);
        formData.append('private_key', privateKey);
        
        // ç»Ÿä¸€é’±åŒ…éªŒè¯ - å¿…é¡»é…ç½®æ‰€æœ‰APIå­—æ®µ
        const hasSpotConfig = spotApiKey && spotSecretKey;
        const hasFuturesConfig = userAddress && signerAddress && privateKey;
        
        if (!hasSpotConfig) {
            showNotification('è¯·å¡«å†™å®Œæ•´çš„ç°è´§APIé…ç½®', 'error');
            return;
        }
        
        if (!hasFuturesConfig) {
            showNotification('è¯·å¡«å†™å®Œæ•´çš„æœŸè´§APIé…ç½®', 'error');
            return;
        }
        
        $.ajax({
            url: '/api/wallets',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#addWalletModal').modal('hide');
                    showNotification('é’±åŒ…æ·»åŠ æˆåŠŸï¼', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('æ·»åŠ å¤±è´¥ï¼š' + response.message, 'error');
                }
            },
            error: function() {
                showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    });
    
    
    // æäº¤ç¼–è¾‘è¡¨å•
    $('#editWalletForm').on('submit', function(e) {
        e.preventDefault();
        
        const walletId = $('#editWalletId').val();
        const formData = new FormData(this);
        
        $.ajax({
            url: `/api/wallets/${walletId}`,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#editWalletModal').modal('hide');
                    showNotification('é’±åŒ…æ›´æ–°æˆåŠŸï¼', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('æ›´æ–°å¤±è´¥ï¼š' + response.message, 'error');
                }
            },
            error: function() {
                showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    });
});

// æµ‹è¯•è¿æ¥
function testConnection(walletId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
    btn.disabled = true;
    
    // æ›´æ–°ä½™é¢æ˜¾ç¤ºçŠ¶æ€
    const balanceDiv = $(`#balance-${walletId}`);
    const balanceSpinner = balanceDiv.find('.fa-sync');
    const balanceContent = balanceDiv.find('.balance-content');
    
    balanceSpinner.show();
    balanceContent.text('è·å–ä½™é¢ä¸­...');
    
    $.ajax({
        url: `/api/wallets/${walletId}/test`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                let message = 'è¿æ¥æµ‹è¯•æˆåŠŸï¼APIé…ç½®æ­£å¸¸';
                let balanceHtml = '';
                
                // æ·»åŠ ä½™é¢ä¿¡æ¯åˆ°é€šçŸ¥å’Œè¡¨æ ¼
                if (response.balance_info) {
                    const balance = response.balance_info;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç»Ÿä¸€é’±åŒ…ï¼ˆåŒ…å«spotå’Œfuturesï¼‰
                    if (balance.spot !== undefined || balance.futures !== undefined) {
                        // ç»Ÿä¸€é’±åŒ…æ˜¾ç¤º
                        message += `<br><strong>é’±åŒ…ä½™é¢ä¿¡æ¯:</strong><br>`;
                        
                        let balanceLines = [];
                        
                        // ç°è´§éƒ¨åˆ†
                        if (balance.spot && balance.spot.status === 'success') {
                            message += `ğŸ’° <strong>ç°è´§USDT:</strong> ${parseFloat(balance.spot.usdt_balance).toFixed(4)}<br>`;
                            if (balance.spot.usdt_locked > 0) {
                                message += `ğŸ”’ é”å®šUSDT: ${parseFloat(balance.spot.usdt_locked).toFixed(4)}<br>`;
                            }
                            balanceLines.push(`<i class="fas fa-coins text-primary"></i> ç°è´§: ${parseFloat(balance.spot.usdt_balance).toFixed(2)}`);
                        } else {
                            message += `âŒ ç°è´§è¿æ¥å¤±è´¥<br>`;
                            balanceLines.push(`<i class="fas fa-exclamation-triangle text-danger"></i> ç°è´§: å¤±è´¥`);
                        }
                        
                        // æœŸè´§éƒ¨åˆ†
                        if (balance.futures && balance.futures.status === 'success') {
                            message += `ğŸ¦ <strong>åˆçº¦USDT:</strong> ${parseFloat(balance.futures.usdt_balance).toFixed(4)}<br>`;
                            message += `ğŸ”¸ å¯ç”¨ä¿è¯é‡‘: ${parseFloat(balance.futures.available_balance).toFixed(4)}<br>`;
                            if (balance.futures.unrealized_pnl !== undefined && balance.futures.unrealized_pnl !== 0) {
                                const pnlClass = balance.futures.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
                                message += `ğŸ“ˆ æœªå®ç°ç›ˆäº: <span class="${pnlClass}">${parseFloat(balance.futures.unrealized_pnl).toFixed(4)}</span><br>`;
                            }
                            balanceLines.push(`<i class="fas fa-chart-line text-warning"></i> åˆçº¦: ${parseFloat(balance.futures.usdt_balance).toFixed(2)}`);
                        } else {
                            message += `âŒ æœŸè´§è¿æ¥å¤±è´¥<br>`;
                            balanceLines.push(`<i class="fas fa-exclamation-triangle text-danger"></i> æœŸè´§: å¤±è´¥`);
                        }
                        
                        // è¡¨æ ¼ä¸­çš„ä½™é¢æ˜¾ç¤º
                        balanceHtml = balanceLines.join('<br>');
                        
                    } else if (balance.usdt_balance !== undefined && balance.usdt_balance !== 'N/A') {
                        // å•ä¸€é’±åŒ…ç±»å‹
                        if (balance.available_balance !== undefined) {
                            // æœŸè´§é’±åŒ…
                            message += `<br><strong>æœŸè´§ä½™é¢ä¿¡æ¯:</strong><br>`;
                            message += `ğŸ’° USDTä½™é¢: ${parseFloat(balance.usdt_balance).toFixed(4)}<br>`;
                            message += `ğŸ”¸ å¯ç”¨ä¿è¯é‡‘: ${parseFloat(balance.available_balance).toFixed(4)}<br>`;
                            if (balance.unrealized_pnl !== undefined && balance.unrealized_pnl !== 0) {
                                const pnlClass = balance.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
                                message += `ğŸ“ˆ æœªå®ç°ç›ˆäº: <span class="${pnlClass}">${parseFloat(balance.unrealized_pnl).toFixed(4)}</span>`;
                            }
                            
                            // è¡¨æ ¼ä¸­çš„ä½™é¢æ˜¾ç¤º
                            balanceHtml = `
                                <i class="fas fa-chart-line text-warning"></i> ${parseFloat(balance.usdt_balance).toFixed(2)}<br>
                                <small class="text-muted">å¯ç”¨: ${parseFloat(balance.available_balance).toFixed(2)}</small>
                            `;
                        } else {
                            // ç°è´§é’±åŒ…
                            message += `<br><strong>ç°è´§ä½™é¢ä¿¡æ¯:</strong><br>`;
                            message += `ğŸ’° å¯ç”¨USDT: ${parseFloat(balance.usdt_balance).toFixed(4)}<br>`;
                            if (balance.usdt_locked !== undefined && balance.usdt_locked !== 0) {
                                message += `ğŸ”’ é”å®šUSDT: ${parseFloat(balance.usdt_locked).toFixed(4)}<br>`;
                            }
                            message += `ğŸ“Š æ€»USDT: ${parseFloat(balance.total_usdt || balance.usdt_balance).toFixed(4)}`;
                            
                            // è¡¨æ ¼ä¸­çš„ä½™é¢æ˜¾ç¤º
                            balanceHtml = `
                                <i class="fas fa-coins text-primary"></i> ${parseFloat(balance.usdt_balance).toFixed(2)}<br>
                                <small class="text-muted">æ€»è®¡: ${parseFloat(balance.total_usdt || balance.usdt_balance).toFixed(2)}</small>
                            `;
                        }
                    } else {
                        balanceHtml = '<span class="text-warning">æ— USDTä½™é¢</span>';
                    }
                } else {
                    balanceHtml = '<span class="text-muted">æ— ä½™é¢ä¿¡æ¯</span>';
                }
                
                // æ›´æ–°è¡¨æ ¼ä¸­çš„ä½™é¢æ˜¾ç¤º
                balanceContent.html(balanceHtml);
                
                showNotification(message, 'success', 8000); // æ˜¾ç¤º8ç§’ä»¥ä¾¿æŸ¥çœ‹ä½™é¢ä¿¡æ¯
            } else {
                balanceContent.html('<span class="text-danger">è·å–å¤±è´¥</span>');
                showNotification('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + response.message, 'error');
            }
        },
        error: function(xhr) {
            let errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            balanceContent.html('<span class="text-danger">è¿æ¥å¤±è´¥</span>');
            showNotification('æµ‹è¯•å¤±è´¥ï¼š' + errorMsg, 'error');
        },
        complete: function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            balanceSpinner.hide();
        }
    });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info', duration = 3000) {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = $(`
        <div class="alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show" 
             role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span style="margin-left: 8px;">${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    // æ·»åŠ åˆ°é¡µé¢
    $('body').append(notification);
    
    // æŒ‡å®šæ—¶é—´åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(function() {
        notification.fadeOut(500, function() {
            $(this).remove();
        });
    }, duration);
}

// ç¼–è¾‘é’±åŒ…
function editWallet(walletId) {
    // è·å–é’±åŒ…ä¿¡æ¯
    $.ajax({
        url: `/api/wallets/${walletId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const wallet = response.wallet;
                
                // å¡«å……åŸºæœ¬ä¿¡æ¯
                $('#editWalletId').val(wallet.id);
                $('#editWalletName').val(wallet.name);
                $('#editWalletDescription').val(wallet.description || '');
                $('#editIsActive').prop('checked', wallet.is_active);
                
                // æ¸…ç©ºæ‰€æœ‰è¡¨å•å­—æ®µ
                $('#editSpotApiKey, #editSpotSecretKey, #editUserAddress, #editSignerAddress, #editPrivateKey').val('');
                
                // æ ¹æ®é’±åŒ…ç±»å‹å¡«å……å¯¹åº”çš„é…ç½®
                if (wallet.wallet_type === 'spot' && wallet.masked_credentials) {
                    // ç°è´§é’±åŒ…ï¼Œæ˜¾ç¤ºAPI Keyçš„æ©ç ç‰ˆæœ¬ä½œä¸ºå ä½ç¬¦
                    if (wallet.masked_credentials.api_key) {
                        $('#editSpotApiKey').attr('placeholder', `å½“å‰API Key: ${wallet.masked_credentials.api_key}`);
                    }
                    if (wallet.masked_credentials.secret_key) {
                        $('#editSpotSecretKey').attr('placeholder', 'å½“å‰Secret Key: ***');
                    }
                } else if (wallet.wallet_type === 'futures') {
                    // åˆçº¦é’±åŒ…ï¼Œæ˜¾ç¤ºåœ°å€ä¿¡æ¯
                    if (wallet.user_address) {
                        $('#editUserAddress').attr('placeholder', `å½“å‰åœ°å€: ${wallet.user_address}`);
                    }
                    if (wallet.signer_address) {
                        $('#editSignerAddress').attr('placeholder', `å½“å‰åœ°å€: ${wallet.signer_address}`);
                    }
                    $('#editPrivateKey').attr('placeholder', 'å½“å‰ç§é’¥: ***');
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                $('#editWalletModal').modal('show');
            } else {
                showNotification('è·å–é’±åŒ…ä¿¡æ¯å¤±è´¥ï¼š' + response.message, 'error');
            }
        },
        error: function() {
            showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        }
    });
}

// åˆ é™¤é’±åŒ…
function deleteWallet(walletId) {
    const confirmMsg = 'âš ï¸ åˆ é™¤é’±åŒ…ç¡®è®¤\n\n' +
                      'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé’±åŒ…å—ï¼Ÿ\n\n' +
                      'æ­¤æ“ä½œå°†ï¼š\n' +
                      'â€¢ æ°¸ä¹…åˆ é™¤é’±åŒ…é…ç½®å’ŒAPIä¿¡æ¯\n' +
                      'â€¢ åŒæ—¶åˆ é™¤æ‰€æœ‰ä½¿ç”¨æ­¤é’±åŒ…çš„ä»»åŠ¡\n' +
                      'â€¢ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\n' +
                      'å¦‚æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œè¯·å…ˆåœæ­¢åå†åˆ é™¤ã€‚';
    
    if (confirm(confirmMsg)) {
        $.ajax({
            url: `/api/wallets/${walletId}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showNotification('é’±åŒ…åˆ é™¤æˆåŠŸï¼', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('åˆ é™¤å¤±è´¥ï¼š' + response.message, 'error');
                }
            },
            error: function() {
                showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    }
}
</script>
{% endblock %}