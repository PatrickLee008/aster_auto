{% extends "base.html" %}

{% block page_title %}任务管理{% if is_admin %}（所有用户）{% endif %}{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
    <i class="fas fa-plus"></i> 创建任务
</button>
{% if current_user.is_admin %}
<button type="button" class="btn btn-warning" onclick="cleanupOrphanTasks()">
    <i class="fas fa-broom"></i> 清理孤儿进程
</button>
{% endif %}
{% endblock %}

{% block content %}
<!-- 用户状态警告 -->
{% if not current_user.account_enabled %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>账户已被禁用</strong> - 您无法创建或启动任务。如需启动任务，请联系管理员启用您的账户。
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> {% if is_admin %}所有任务{% else %}我的任务{% endif %}</h5>
            </div>
            <div class="card-body">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>任务名称</th>
                                {% if is_admin %}
                                <th>用户</th>
                                {% endif %}
                                <th>钱包</th>
                                <th>策略</th>
                                <th>交易对</th>
                                <th>状态</th>
                                <th>执行统计</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr id="task-{{ task.id }}">
                                <td>
                                    <div>
                                        <strong>{{ task.name }}</strong>
                                        {% if task.description %}
                                        <br><small class="text-muted">{{ task.description }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                {% if is_admin %}
                                <td>
                                    <div>
                                        <i class="fas fa-user me-1"></i>
                                        <strong>{{ task.creator.username }}</strong>
                                        {% if task.creator.nickname %}
                                        <br><small class="text-muted">{{ task.creator.nickname }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endif %}
                                <td>
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-wallet"></i> {{ task.wallet.name }}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        {% if task.wallet.wallet_type == 'spot' %}
                                            <i class="fas fa-coins"></i> 现货
                                        {% else %}
                                            <i class="fas fa-chart-line"></i> 合约
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div>
                                        {{ task.strategy.name }}
                                        <br>
                                        <small class="text-muted">{{ task.strategy.strategy_type }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">
                                        <i class="fas fa-exchange-alt"></i> {{ task.symbol }}
                                    </span>
                                    <br>
                                    <small class="{{ 'text-success' if task.status == 'running' else 'text-muted' }}">
                                        {{ '正在执行' if task.status == 'running' else '未运行' }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 
                                        'success' if task.status == 'running' else
                                        'secondary' if task.status == 'stopped' else  
                                        'danger' if task.status == 'error' else
                                        'warning' if task.status == 'paused' else 'light'
                                    }}">
                                        {% if task.status == 'running' %}
                                            <i class="fas fa-play"></i> 运行中
                                        {% elif task.status == 'stopped' %}
                                            <i class="fas fa-stop"></i> 已停止
                                        {% elif task.status == 'error' %}
                                            <i class="fas fa-exclamation-triangle"></i> 错误
                                        {% elif task.status == 'paused' %}
                                            <i class="fas fa-pause"></i> 暂停
                                        {% endif %}
                                    </span>
                                    {% if task.process_id %}
                                    <br><small class="text-muted">PID: {{ task.process_id }}</small>
                                    {% endif %}
                                    {% if task.last_error %}
                                    <br><small class="text-danger" title="{{ task.last_error }}">
                                        <i class="fas fa-info-circle"></i> 
                                        {{ task.last_error[:50] + '...' if task.last_error|length > 50 else task.last_error }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="small">
                                        <strong>完成: {{ task.successful_rounds }}/{{ task.rounds }}</strong>
                                        {% if task.supplement_orders > 0 %}
                                        <br>补单: <span class="text-warning">{{ task.supplement_orders }}</span>
                                        {% endif %}
                                        
                                        <br><strong>交易量统计:</strong>
                                        <br>买单: <span class="text-success">{{ task.buy_volume_usdt or 0 }} USDT</span>
                                        <br>卖单: <span class="text-info">{{ task.sell_volume_usdt or 0 }} USDT</span>
                                        <br>总量: <span class="text-primary">{{ (task.buy_volume_usdt or 0) + (task.sell_volume_usdt or 0) }} USDT</span>
                                        
                                        <br>手续费: <span class="text-warning">{{ task.total_fees_usdt or 0 }} USDT</span>
                                        
                                        {% if task.usdt_balance_diff is not none %}
                                        <br>磨损（含手续费）: <span class="{{ 'text-success' if task.usdt_balance_diff >= 0 else 'text-danger' }}">{{ task.usdt_balance_diff }} USDT</span>
                                        {% endif %}
                                        
                                        
                                    </div>
                                </td>
                                <td>
                                    <small>{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% if task.start_time %}
                                    <br><small class="text-muted">启动: {{ task.start_time.strftime('%H:%M') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if task.status == 'stopped' or task.status == 'error' %}
                                        <button type="button" class="btn btn-outline-success"
                                                onclick="startTask({{ task.id }})">
                                            <i class="fas fa-play"></i> 启动
                                        </button>
                                        {% elif task.status == 'running' %}
                                        <button type="button" class="btn btn-outline-warning"
                                                onclick="pauseTask({{ task.id }})">
                                            <i class="fas fa-pause"></i> 暂停
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="stopTask({{ task.id }})">
                                            <i class="fas fa-stop"></i> 停止
                                        </button>
                                        {% elif task.status == 'paused' %}
                                        <button type="button" class="btn btn-outline-success"
                                                onclick="resumeTask({{ task.id }})">
                                            <i class="fas fa-play"></i> 继续
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="stopTask({{ task.id }})">
                                            <i class="fas fa-stop"></i> 停止
                                        </button>
                                        {% endif %}
                                        
                                        <button type="button" class="btn btn-outline-info"
                                                onclick="viewTaskLogs({{ task.id }})">
                                            <i class="fas fa-file-alt"></i> 日志
                                        </button>
                                        
                                        {% if task.status not in ['running', 'paused'] %}
                                        <button type="button" class="btn btn-outline-secondary"
                                                onclick="editTask({{ task.id }})">
                                            <i class="fas fa-edit"></i> 编辑
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="deleteTask({{ task.id }})">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无交易任务</h5>
                    <p class="text-muted">创建您的第一个交易任务以开始自动化交易</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                        <i class="fas fa-plus"></i> 创建任务
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 创建任务模态框 -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> 创建交易任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTaskForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskName" class="form-label">任务名称 *</label>
                                <input type="text" class="form-control" id="taskName" name="name" required maxlength="100" readonly>
                                <div class="form-text">自动生成：交易对_数量_次数次</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskWallet" class="form-label">选择钱包 *</label>
                                <select class="form-select" id="taskWallet" name="wallet_id" required>
                                    <option value="">选择钱包</option>
                                    {% for wallet in wallets %}
                                    <option value="{{ wallet.id }}" data-type="{{ wallet.wallet_type }}">
                                        {{ wallet.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskStrategy" class="form-label">选择策略 *</label>
                        <select class="form-select" id="taskStrategy" name="strategy_id" required>
                            <option value="">选择策略</option>
                            {% for strategy in strategies %}
                            <option value="{{ strategy.id }}" 
                                    data-supported-types="{{ strategy.supported_wallet_types }}"
                                    data-default-params="{{ strategy.get_default_parameters() | tojson | e }}">
                                {{ strategy.name }} - {{ strategy.description }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cogs"></i> 交易参数</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="taskSymbol" class="form-label">
                                        交易品种 <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="taskSymbol" name="symbol" 
                                           placeholder="例如: BTCUSDT" required>
                                    <div class="form-text">请输入交易对符号，如BTCUSDT, ETHUSDT等</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="taskQuantity" class="form-label">
                                        每次交易数量 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="taskQuantity" name="quantity" 
                                               min="0.001" step="0.001" placeholder="0.001" required>
                                        <span class="input-group-text" id="quantityUnit">-</span>
                                    </div>
                                    <div class="form-text">每次交易的数量，请根据交易对精度设置</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="taskUsdtValue" class="form-label">
                                        等价USDT价值
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="taskUsdtValue" 
                                               min="0.01" step="0.01" placeholder="100.00">
                                        <span class="input-group-text">USDT</span>
                                    </div>
                                    <div class="form-text">
                                        <span id="priceInfo">请先选择交易对获取价格</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="taskRounds" class="form-label">
                                        循环次数 <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="taskRounds" name="rounds" 
                                           min="1" step="1" placeholder="10" required>
                                    <div class="form-text">总共执行多少轮交易</div>
                                </div>
                                <div class="col-md-6 mb-3" id="taskLeverageContainer">
                                    <label for="taskLeverage" class="form-label">杠杆倍数 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="taskLeverage" name="leverage" required>
                                        <option value="5">5x</option>
                                        <option value="10">10x</option>
                                        <option value="20" selected>20x</option>
                                        <option value="50">50x</option>
                                        <option value="100">100x</option>
                                    </select>
                                    <div class="form-text">合约交易杠杆倍数</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 创建任务
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑任务模态框 -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> 编辑交易任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskName" class="form-label">任务名称 *</label>
                                <input type="text" class="form-control" id="editTaskName" name="name" required maxlength="100" readonly>
                                <div class="form-text">任务名称不可编辑</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskWallet" class="form-label">选择钱包 *</label>
                                <select class="form-select" id="editTaskWallet" name="wallet_id" required>
                                    <option value="">选择钱包</option>
                                    {% for wallet in wallets %}
                                    <option value="{{ wallet.id }}" data-type="{{ wallet.wallet_type }}">
                                        {{ wallet.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDescription" class="form-label">任务描述</label>
                        <textarea class="form-control" id="editTaskDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskStrategy" class="form-label">选择策略 *</label>
                        <select class="form-select" id="editTaskStrategy" name="strategy_id" required>
                            <option value="">选择策略</option>
                            {% for strategy in strategies %}
                            <option value="{{ strategy.id }}" 
                                    data-supported-types="{{ strategy.supported_wallet_types }}"
                                    data-default-params="{{ strategy.get_default_parameters() | tojson | e }}">
                                {{ strategy.name }} - {{ strategy.description }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cogs"></i> 交易参数</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editTaskSymbol" class="form-label">
                                        交易品种 <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="editTaskSymbol" name="symbol" 
                                           placeholder="例如: BTCUSDT" required>
                                    <div class="form-text">请输入交易对符号，如BTCUSDT, ETHUSDT等</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editTaskQuantity" class="form-label">
                                        每次交易数量 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="editTaskQuantity" name="quantity" 
                                               min="0.001" step="0.001" placeholder="0.001" required>
                                        <span class="input-group-text" id="editQuantityUnit">-</span>
                                    </div>
                                    <div class="form-text">每次交易的数量，请根据交易对精度设置</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editTaskUsdtValue" class="form-label">
                                        等价USDT价值
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="editTaskUsdtValue" 
                                               min="0.01" step="0.01" placeholder="100.00">
                                        <span class="input-group-text">USDT</span>
                                    </div>
                                    <div class="form-text">
                                        <span id="editPriceInfo">请先选择交易对获取价格</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editTaskRounds" class="form-label">
                                        循环次数 <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="editTaskRounds" name="rounds" 
                                           min="1" step="1" placeholder="10" required>
                                    <div class="form-text">总共执行多少轮交易</div>
                                </div>
                                <div class="col-md-6 mb-3" id="editTaskLeverageContainer">
                                    <label for="editTaskLeverage" class="form-label">杠杆倍数 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editTaskLeverage" name="leverage" required>
                                        <option value="5">5x</option>
                                        <option value="10">10x</option>
                                        <option value="20" selected>20x</option>
                                        <option value="50">50x</option>
                                        <option value="100">100x</option>
                                    </select>
                                    <div class="form-text">合约交易杠杆倍数</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 任务日志模态框 -->
<div class="modal fade" id="taskLogsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> 任务日志</h5>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" checked>
                        <label class="form-check-label" for="autoRefreshSwitch">
                            <small>自动刷新</small>
                        </label>
                    </div>
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="autoScrollSwitch" checked>
                        <label class="form-check-label" for="autoScrollSwitch">
                            <small>自动滚动</small>
                        </label>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <pre id="taskLogsContent" style="max-height: 500px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem;">
                    加载中...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="clearTaskLogs()">
                    <i class="fas fa-trash"></i> 清除日志
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                    <i class="fas fa-refresh"></i> 刷新
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;

$(document).ready(function() {
    // 全局变量
    let currentPrice = null;
    let isCalculating = false;
    
    function generateTaskName() {
        const rawSymbol = ($('#taskSymbol').val() || '').toUpperCase().trim();
        const qty = ($('#taskQuantity').val() || '').trim();
        const rounds = ($('#taskRounds').val() || '').trim();
        if (!rawSymbol || !qty || !rounds) {
            return '';
        }
        const quoteSuffixes = ['USD1', 'USDT', 'USDC', 'BUSD', 'FDUSD', 'TUSD', 'USDP', 'DAI', 'TRY', 'EUR', 'BRL', 'BTC', 'ETH', 'BNB', 'USD'];
        let baseSymbol = rawSymbol;
        for (const suffix of quoteSuffixes) {
            if (rawSymbol.endsWith(suffix)) {
                baseSymbol = rawSymbol.slice(0, -suffix.length) || rawSymbol;
                break;
            }
        }
        return `${baseSymbol}_${qty}_${rounds}次`;
    }


    function updateTaskName() {
        const name = generateTaskName();
        if (name) {
            $('#taskName').val(name);
        } else {
            $('#taskName').val('');
        }
    }


    // 获取交易对价格
    function fetchSymbolPrice(symbol, context = 'create') {
        if (!symbol || symbol.length < 6) return;
        
        const priceInfoId = context === 'create' ? '#priceInfo' : '#editPriceInfo';
        const quantityUnitId = context === 'create' ? '#quantityUnit' : '#editQuantityUnit';
        
        $(priceInfoId).text('获取价格中...');
        $(quantityUnitId).text('-');
        
        $.ajax({
            url: `/api/tasks/price/${symbol}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    currentPrice = response.price;
                    $(priceInfoId).html(`价格: <strong>${response.price}</strong> USDT`);
                    
                    // 更新数量单位显示
                    const baseSymbol = getBaseSymbol(symbol);
                    $(quantityUnitId).text(baseSymbol);
                } else {
                    $(priceInfoId).text('获取价格失败: ' + response.message);
                    currentPrice = null;
                    $(quantityUnitId).text('-');
                }
            },
            error: function() {
                $(priceInfoId).text('网络错误，无法获取价格');
                currentPrice = null;
                $(quantityUnitId).text('-');
            }
        });
    }
    
    // 获取基础币种符号
    function getBaseSymbol(symbol) {
        const quoteSuffixes = ['USDT', 'USDC', 'BUSD', 'FDUSD', 'TUSD', 'USDP', 'DAI', 'USD'];
        for (const suffix of quoteSuffixes) {
            if (symbol.endsWith(suffix)) {
                return symbol.slice(0, -suffix.length) || symbol;
            }
        }
        return symbol;
    }
    
    // 数量转USDT价值
    function quantityToUsdt(quantity, context = 'create') {
        if (!currentPrice || !quantity || isCalculating) return;
        
        isCalculating = true;
        const usdtValue = (parseFloat(quantity) * currentPrice).toFixed(2);
        const usdtInputId = context === 'create' ? '#taskUsdtValue' : '#editTaskUsdtValue';
        $(usdtInputId).val(usdtValue);
        isCalculating = false;
    }
    
    // USDT价值转数量
    function usdtToQuantity(usdtValue, context = 'create') {
        if (!currentPrice || !usdtValue || isCalculating) return;
        
        isCalculating = true;
        const quantity = (parseFloat(usdtValue) / currentPrice).toFixed(8);
        const quantityInputId = context === 'create' ? '#taskQuantity' : '#editTaskQuantity';
        $(quantityInputId).val(quantity);
        isCalculating = false;
        
        // 更新任务名称
        if (context === 'create') {
            updateTaskName();
        } else {
            updateEditTaskName();
        }
    }
    
    // 事件监听器
    $('#taskSymbol').on('blur', function() {
        const symbol = $(this).val().toUpperCase().trim();
        if (symbol) {
            fetchSymbolPrice(symbol, 'create');
        }
    });
    
    $('#taskQuantity').on('input', function() {
        quantityToUsdt($(this).val(), 'create');
    });
    
    $('#taskUsdtValue').on('input', function() {
        usdtToQuantity($(this).val(), 'create');
    });
    
    $('#editTaskSymbol').on('blur', function() {
        const symbol = $(this).val().toUpperCase().trim();
        if (symbol) {
            fetchSymbolPrice(symbol, 'edit');
        }
    });
    
    $('#editTaskQuantity').on('input', function() {
        quantityToUsdt($(this).val(), 'edit');
    });
    
    $('#editTaskUsdtValue').on('input', function() {
        usdtToQuantity($(this).val(), 'edit');
    });

    $('#taskSymbol, #taskQuantity, #taskRounds').on('input change', updateTaskName);
    $('#editTaskSymbol, #editTaskQuantity, #editTaskRounds').on('input change', updateEditTaskName);
    updateTaskName();

    // 钱包选择变化时过滤策略
    $('#taskWallet, #editTaskWallet').on('change', function() {
        const walletType = $(this).find('option:selected').data('type');
        const strategySelector = $(this).attr('id') === 'taskWallet' ? '#taskStrategy' : '#editTaskStrategy';
        
        $(strategySelector + ' option').each(function() {
            const supportedTypes = $(this).data('supported-types');
            
            // 统一钱包兼容所有策略
            if (walletType === 'unified') {
                $(this).show();
            } else if (supportedTypes && supportedTypes.includes(walletType)) {
                $(this).show();
            } else if ($(this).val() === '') {
                $(this).show(); // 保留空选项
            } else {
                $(this).hide();
            }
        });
        $(strategySelector).val('').trigger('change');
    });
    
    // 根据钱包类型显示/隐藏杠杆字段
    function toggleLeverageField(context) {
        let walletSelector, leverageContainer;
        
        if (context === 'edit') {
            walletSelector = '#editTaskWallet';
            leverageContainer = '#editTaskLeverageContainer';
        } else {
            walletSelector = '#taskWallet';
            leverageContainer = '#taskLeverageContainer';
        }
        
        const selectedWallet = $(walletSelector + ' option:selected');
        const walletType = selectedWallet.data('type');
        
        if (walletType === 'futures') {
            // 合约交易：显示杠杆字段并设为必填
            $(leverageContainer).show();
            $(leverageContainer).find('select').prop('required', true);
        } else if (walletType === 'spot') {
            // 现货交易：完全隐藏杠杆字段并设为默认值1
            $(leverageContainer).hide();
            $(leverageContainer).find('select').prop('required', false).val(1);
        } else {
            // 未选择钱包时隐藏
            $(leverageContainer).hide();
            $(leverageContainer).find('select').prop('required', false);
        }
    }
    
    // 钱包选择变化时更新杠杆字段显示状态
    $('#taskWallet').on('change', function() {
        toggleLeverageField('create');
    });
    
    $('#editTaskWallet').on('change', function() {
        toggleLeverageField('edit');
    });
    
    // 页面加载时初始化杠杆字段状态
    toggleLeverageField('create');
    toggleLeverageField('edit');
    
    // 移除了策略选择变化时的交易方向字段更新逻辑
    // 交易方向由策略内部决定，不需要用户选择
    
    // 提交任务表单
    $('#createTaskForm').on('submit', function(e) {
        e.preventDefault();
        updateTaskName();
        if (!$('#taskName').val()) {
            alert('请先输入交易对、数量和次数，以生成任务名称');
            return;
        }
        
        // 根据钱包类型确定杠杆值
        const selectedWallet = $('#taskWallet option:selected');
        const walletType = selectedWallet.data('type');
        let leverage = 1; // 现货默认值
        
        if (walletType === 'futures') {
            leverage = $('#taskLeverage').val();
        }
        
        const formData = {
            name: $('#taskName').val(),
            description: $('#taskDescription').val(),
            wallet_id: $('#taskWallet').val(),
            strategy_id: $('#taskStrategy').val(),
            symbol: $('#taskSymbol').val(),
            quantity: $('#taskQuantity').val(),
            interval: 0,  // 不再使用间隔时间
            rounds: $('#taskRounds').val(),
            leverage: leverage,
            side: 'both',  // 固定为双向交易，由策略内部决定具体方向
            order_type: 'market'  // 暂时固定为市价单
        };
        
        $.ajax({
            url: '/api/tasks',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('创建失败：' + response.message);
                }
            },
            error: function() {
                alert('网络错误，请重试');
            }
        });
    });
    
    // 提交编辑任务表单
    $('#editTaskForm').on('submit', function(e) {
        e.preventDefault();
        
        // 更新任务名称
        updateEditTaskName();
        if (!$('#editTaskName').val()) {
            alert('请先输入交易对、数量和次数，以生成任务名称');
            return;
        }
        
        // 根据钱包类型确定杠杆值
        const selectedEditWallet = $('#editTaskWallet option:selected');
        const editWalletType = selectedEditWallet.data('type');
        let editLeverage = 1; // 现货默认值
        
        if (editWalletType === 'futures') {
            editLeverage = $('#editTaskLeverage').val();
        }
        
        const formData = {
            name: $('#editTaskName').val(),
            description: $('#editTaskDescription').val(),
            wallet_id: $('#editTaskWallet').val(),
            strategy_id: $('#editTaskStrategy').val(),
            symbol: $('#editTaskSymbol').val(),
            quantity: $('#editTaskQuantity').val(),
            interval: 0,  // 不再使用间隔时间
            rounds: $('#editTaskRounds').val(),
            leverage: editLeverage,
            side: 'both',  // 固定为双向交易，由策略内部决定具体方向
            order_type: 'market'
        };
        
        const taskId = $('#editTaskId').val();
        
        $.ajax({
            url: `/api/tasks/${taskId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    $('#editTaskModal').modal('hide');
                    location.reload();
                } else {
                    alert('更新失败：' + response.message);
                }
            },
            error: function() {
                alert('网络错误，请重试');
            }
        });
    });
    
    // 日志模态框事件监听器
    $('#autoRefreshSwitch').on('change', function() {
        if ($(this).is(':checked')) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // 模态框关闭时停止自动刷新
    $('#taskLogsModal').on('hide.bs.modal', function() {
        stopAutoRefresh();
    });
    
    // 模态框显示时启动自动刷新
    $('#taskLogsModal').on('show.bs.modal', function() {
        if ($('#autoRefreshSwitch').is(':checked')) {
            startAutoRefresh();
        }
    });
});


// 任务控制函数
function startTask(taskId) {
    controlTask(taskId, 'start');
}

function stopTask(taskId) {
    controlTask(taskId, 'stop');
}

function pauseTask(taskId) {
    controlTask(taskId, 'pause');
}

function resumeTask(taskId) {
    controlTask(taskId, 'resume');
}

function controlTask(taskId, action) {
    console.log(`执行任务操作: ${action}, 任务ID: ${taskId}`);
    
    $.ajax({
        url: `/api/tasks/${taskId}/${action}`,
        method: 'POST',
        success: function(response) {
            console.log('任务操作响应:', response);
            
            if (response.success) {
                // 显示成功信息
                const actionNames = {
                    'start': '启动',
                    'stop': '停止', 
                    'pause': '暂停',
                    'resume': '恢复'
                };
                
                alert(`任务${actionNames[action]}成功：${response.message}`);
                
                // 刷新任务状态
                setTimeout(() => location.reload(), 500);
            } else {
                alert(`操作失败：${response.message}`);
            }
        },
        error: function(xhr, status, error) {
            console.error('任务操作失败:', status, error, xhr.responseText);
            
            let errorMessage = '网络错误，请重试';
            if (xhr.responseText) {
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    errorMessage = errorResponse.message || errorMessage;
                } catch (e) {
                    // 解析失败，使用默认错误信息
                }
            }
            
            alert(errorMessage);
        }
    });
}

// 全局变量
let autoRefreshTimer = null;

// 查看任务日志
function viewTaskLogs(taskId) {
    currentTaskId = taskId;
    $('#taskLogsModal').modal('show');
    loadTaskLogs(taskId);
    
    // 启动自动刷新
    startAutoRefresh();
}

function loadTaskLogs(taskId, silent = false) {
    // 静默模式下不显示"加载中..."，避免显示框收缩
    if (!silent) {
        $('#taskLogsContent').text('加载中...');
    }
    
    $.ajax({
        url: `/api/tasks/${taskId}/logs`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const logs = response.logs || '暂无日志';
                
                // 检查是否是"尚未生成日志文件"的情况
                if (logs.includes('尚未生成日志文件') || logs.includes('日志文件为空')) {
                    // 隐藏清除日志按钮
                    $('#taskLogsModal .btn-danger').hide();
                    
                    // 为没有日志的任务提供友好提示
                    $('#taskLogsContent').html(`<div style="text-align: center; color: #6c757d; padding: 40px;">
                        <i class="fas fa-file-alt fa-3x mb-3" style="opacity: 0.5;"></i>
                        <h5>暂无日志记录</h5>
                        <p>该任务尚未生成日志文件，可能的原因：</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>任务从未启动过</li>
                            <li>任务正在启动中，日志文件尚未创建</li>
                            <li>日志文件被意外删除</li>
                        </ul>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary btn-sm" onclick="startTaskFromLogs(${taskId})">
                                <i class="fas fa-play"></i> 启动任务
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="refreshLogs()">
                                <i class="fas fa-refresh"></i> 刷新日志
                            </button>
                        </div>
                    </div>`);
                } else {
                    // 显示清除日志按钮
                    $('#taskLogsModal .btn-danger').show();
                    
                    // 正常显示日志内容
                    $('#taskLogsContent').text(logs);
                    
                    // 自动滚动到底部 - 首次加载强制滚动，自动刷新智能滚动
                    if (silent) {
                        scrollToBottom(); // 自动刷新，智能滚动
                    } else {
                        // 首次加载，强制滚动到底部
                        setTimeout(() => {
                            const logsContent = document.getElementById('taskLogsContent');
                            if (logsContent) {
                                logsContent.scrollTop = logsContent.scrollHeight;
                            }
                        }, 100);
                    }
                }
            } else {
                $('#taskLogsContent').html(`<div style="text-align: center; color: #dc3545; padding: 20px;">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>加载日志失败</h5>
                    <p>${response.message}</p>
                    <button class="btn btn-secondary btn-sm" onclick="refreshLogs()">
                        <i class="fas fa-refresh"></i> 重试
                    </button>
                </div>`);
            }
        },
        error: function() {
            $('#taskLogsContent').html(`<div style="text-align: center; color: #dc3545; padding: 20px;">
                <i class="fas fa-wifi fa-2x mb-3" style="opacity: 0.5;"></i>
                <h5>网络连接错误</h5>
                <p>无法连接到服务器，请检查网络连接</p>
                <button class="btn btn-secondary btn-sm" onclick="refreshLogs()">
                    <i class="fas fa-refresh"></i> 重试
                </button>
            </div>`);
        }
    });
}

// 从日志对话框启动任务
function startTaskFromLogs(taskId) {
    controlTask(taskId, 'start');
    // 关闭日志对话框
    setTimeout(() => {
        $('#taskLogsModal').modal('hide');
    }, 1000);
}

function refreshLogs() {
    if (currentTaskId) {
        loadTaskLogs(currentTaskId);
    }
}

// 自动滚动到底部
function scrollToBottom() {
    if ($('#autoScrollSwitch').is(':checked')) {
        const logsContent = document.getElementById('taskLogsContent');
        if (logsContent) {
            // 检查用户是否已经在底部附近（容忍50px的误差）
            const isNearBottom = logsContent.scrollTop + logsContent.clientHeight >= logsContent.scrollHeight - 50;
            
            // 只有用户在底部附近时才自动滚动
            if (isNearBottom) {
                setTimeout(() => {
                    logsContent.scrollTop = logsContent.scrollHeight;
                }, 100);
            }
        }
    }
}

// 启动自动刷新
function startAutoRefresh() {
    stopAutoRefresh(); // 先停止之前的定时器
    
    if ($('#autoRefreshSwitch').is(':checked')) {
        autoRefreshTimer = setInterval(() => {
            if ($('#autoRefreshSwitch').is(':checked') && currentTaskId && $('#taskLogsModal').hasClass('show')) {
                loadTaskLogs(currentTaskId, true); // 使用静默模式
            }
        }, 5000); // 每5秒刷新一次
    }
}

// 停止自动刷新
function stopAutoRefresh() {
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
}

// 清除任务日志
function clearTaskLogs() {
    if (!currentTaskId) {
        return;
    }
    
    if (!confirm('确定要清除这个任务的所有日志吗？此操作不可恢复！')) {
        return;
    }
    
    $.ajax({
        url: `/api/tasks/${currentTaskId}/logs/clear`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                alert('日志清除成功');
                // 刷新日志显示
                loadTaskLogs(currentTaskId);
            } else {
                alert('日志清除失败：' + response.message);
            }
        },
        error: function() {
            alert('网络错误，无法清除日志');
        }
    });
}

// 编辑任务
function editTask(taskId) {
    // 获取任务详情
    $.ajax({
        url: `/api/tasks/${taskId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const task = response.task;
                populateEditForm(task);
                $('#editTaskModal').modal('show');
            } else {
                alert('获取任务信息失败：' + response.message);
            }
        },
        error: function() {
            alert('网络错误，无法获取任务信息');
        }
    });
}

// 生成编辑任务名称
function generateEditTaskName() {
    const rawSymbol = ($('#editTaskSymbol').val() || '').toUpperCase().trim();
    const qty = ($('#editTaskQuantity').val() || '').trim();
    const rounds = ($('#editTaskRounds').val() || '').trim();
    if (!rawSymbol || !qty || !rounds) {
        return '';
    }
    const quoteSuffixes = ['USD1', 'USDT', 'USDC', 'BUSD', 'FDUSD', 'TUSD', 'USDP', 'DAI', 'TRY', 'EUR', 'BRL', 'BTC', 'ETH', 'BNB', 'USD'];
    let baseSymbol = rawSymbol;
    for (const suffix of quoteSuffixes) {
        if (rawSymbol.endsWith(suffix)) {
            baseSymbol = rawSymbol.slice(0, -suffix.length) || rawSymbol;
            break;
        }
    }
    return `${baseSymbol}_${qty}_${rounds}次`;
}

// 更新编辑任务名称
function updateEditTaskName() {
    const name = generateEditTaskName();
    if (name) {
        $('#editTaskName').val(name);
    } else {
        $('#editTaskName').val('');
    }
}

// 填充编辑表单
function populateEditForm(task) {
    $('#editTaskName').val(task.name);
    $('#editTaskDescription').val(task.description);
    $('#editTaskWallet').val(task.wallet.id);
    $('#editTaskStrategy').val(task.strategy.id);
    $('#editTaskId').val(task.id);
    
    // 触发钱包选择变化事件以更新杠杆字段显示
    $('#editTaskWallet').trigger('change');
    
    // 填充交易参数
    const params = task.parameters || {};
    $('#editTaskSymbol').val(params.symbol || task.symbol || '');
    $('#editTaskQuantity').val(params.quantity || task.quantity || '');
    // interval字段已移除，不再需要设置
    $('#editTaskRounds').val(params.rounds || task.rounds || '');
    
    // 根据钱包类型处理杠杆字段
    if (task.wallet.wallet_type === 'futures') {
        $('#editTaskLeverage').val(params.leverage || task.leverage || 20);
    }
    // 现货钱包的杠杆值会自动设为1，无需手动设置
    // 交易方向由策略内部决定，不需要用户编辑
    
    // 更新任务名称
    updateEditTaskName();
    
    // 获取当前交易对的价格
    const symbol = params.symbol || task.symbol || '';
    if (symbol) {
        fetchSymbolPrice(symbol, 'edit');
        // 计算当前的USDT价值
        setTimeout(() => {
            if (currentPrice) {
                quantityToUsdt($('#editTaskQuantity').val(), 'edit');
            }
        }, 1000);
    }
}

// 删除任务
function deleteTask(taskId) {
    if (confirm('确定要删除这个任务吗？此操作不可恢复！')) {
        $.ajax({
            url: `/api/tasks/${taskId}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('删除失败：' + response.message);
                }
            },
            error: function() {
                alert('网络错误，请重试');
            }
        });
    }
}

// 清理孤儿任务
function cleanupOrphanTasks() {
    if (!confirm('确定要清理孤儿进程吗？这将停止所有进程ID无效或已停止的任务。')) {
        return;
    }
    
    $.ajax({
        url: '/api/tasks/cleanup',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                alert('清理完成：' + response.message);
                location.reload();
            } else {
                alert('清理失败：' + response.message);
            }
        },
        error: function() {
            alert('网络错误，无法清理孤儿任务');
        }
    });
}

// 手动刷新功能 - 避免自动刷新造成的卡顿
function refreshTaskStatuses() {
    location.reload();
}

// 刷新进度功能已移除

</script>
{% endblock %}
